name: Auto Release (.NET 4.8)

on:
  # Trigger on push to main/master ONLY if the commit message contains specific flags
  push:
    branches:
      - main
      - master
  
  # Keep manual trigger for testing (optional)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    # Only run if it's a manual trigger OR if the commit message contains one of the version flags
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '(major)') ||
      contains(github.event.head_commit.message, '(minor)') ||
      contains(github.event.head_commit.message, '(patch)') ||
      contains(github.event.head_commit.message, '(build)')

    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Update AssemblyInfo.cs (BUMP VERSION)
      - name: Bump Version in AssemblyInfo
        id: bump_version
        shell: powershell
        run: |
          $assemblyFile = "src/Properties/AssemblyInfo.cs"
          
          # Check if file exists
          if (-not (Test-Path $assemblyFile)) {
            Write-Error "AssemblyInfo.cs not found at $assemblyFile"
            exit 1
          }

          # Read the file content
          $content = Get-Content -Path $assemblyFile -Raw
          
          # Regex to find [assembly: AssemblyVersion("1.0.0.0")]
          $pattern = '\[assembly: AssemblyVersion\("(\d+)\.(\d+)\.(\d+)\.(\d+)"\)\]'
          
          if ($content -match $pattern) {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            $patch = [int]$matches[3]
            $build = [int]$matches[4]
            
            Write-Host "Current Version: $major.$minor.$patch.$build"
            
            # Get Commit Message
            $commitMsg = "${{ github.event.head_commit.message }}"
            if ([string]::IsNullOrEmpty($commitMsg)) { $commitMsg = "manual trigger (build)" }

            # Logic: Build increments EVERY TIME
            $newBuild = $build + 1
            $newMajor = $major
            $newMinor = $minor
            $newPatch = $patch

            # Apply Logic based on flags
            if ($commitMsg -match '\(major\)') {
              $newMajor = $major + 1
              $newMinor = 0 # Standard behavior: Reset lower tiers on Major bump
              $newPatch = 0
            } elseif ($commitMsg -match '\(minor\)') {
              $newMinor = $minor + 1
              $newPatch = 0 # Standard behavior: Reset patch on Minor bump
            } elseif ($commitMsg -match '\(patch\)') {
              $newPatch = $patch + 1
            } 
            # If (build) or no other flag, only $newBuild is updated (already done above)

            $newVersion = "$newMajor.$newMinor.$newPatch.$newBuild"
            Write-Host "New Version: $newVersion"
            
            # Replace in content
            $newContent = $content -replace $pattern, "[assembly: AssemblyVersion(""$newVersion"")]"
            
            # Also update AssemblyFileVersion if present, usually good practice
            $fileVersionPattern = '\[assembly: AssemblyFileVersion\("(\d+)\.(\d+)\.(\d+)\.(\d+)"\)\]'
            $newContent = $newContent -replace $fileVersionPattern, "[assembly: AssemblyFileVersion(""$newVersion"")]"

            # Write back to file
            Set-Content -Path $assemblyFile -Value $newContent -Encoding UTF8
            
            # Set output for next steps
            echo "version=$newVersion" >> $env:GITHUB_OUTPUT
            echo "version_changed=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Warning "Could not find AssemblyVersion pattern in $assemblyFile"
            echo "version_changed=false" >> $env:GITHUB_OUTPUT
          }

      # 3. Commit and Push the Version Bump
      - name: Commit and Push Version Bump
        if: steps.bump_version.outputs.version_changed == 'true'
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add src/Properties/AssemblyInfo.cs
          git commit -m "Bump version to ${{ steps.bump_version.outputs.version }} [skip ci]"
          git push

      # 4. Prepare Release Notes
      - name: Prepare Release Notes
        id: release_notes
        shell: powershell
        run: |
          $notesFile = "RELEASE_NOTES.md" 
          $tempNotes = "final_release_notes.tmp"
          
          # Add commit message as summary
          Add-Content -Path $tempNotes -Value "## Commit Message`n"
          Add-Content -Path $tempNotes -Value "${{ github.event.head_commit.message }}`n"
          Add-Content -Path $tempNotes -Value "---`n"

          if (Test-Path $notesFile) {
            $fileContent = Get-Content -Path $notesFile -Raw
            Add-Content -Path $tempNotes -Value "$fileContent"
          } else {
            Set-Content -Path $tempNotes -Value "Automated release based on commit."
          }

      # 5. Setup MSBuild
      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      # 6. Setup NuGet
      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      # 7. Restore NuGet Packages
      - name: Restore NuGet Packages
        run: nuget restore src/ScientificReviews.sln

      # 8. Build Release using MSBuild
      - name: Build App
        run: msbuild src/ScientificReviews.csproj /p:Configuration=Release /p:Platform="Any CPU" /p:OutputPath=./publish

      # 9. Zip the output
      - name: Zip Build
        run: Compress-Archive -Path ./src/publish/* -DestinationPath ScientificReviews.zip

      # 10. Create Release
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.bump_version.outputs.version }}
          name: Release v${{ steps.bump_version.outputs.version }}
          body_path: final_release_notes.tmp
          generate_release_notes: true
          files: |
            ScientificReviews.zip